# Pre-create KbsConfig CR to inject custom configuration
#
# This KbsConfig is created BEFORE the TrusteeConfig reconciles.
# When TrusteeConfig creates/updates the KbsConfig, it will use smart-merge
# logic to preserve certain fields, including kbsSecretResources.
#
# This allows us to pre-configure which secrets are loaded into Trustee KBS
# without requiring post-deployment patches.
apiVersion: confidentialcontainers.org/v1alpha1
kind: KbsConfig
metadata:
  labels:
    app.kubernetes.io/name: kbsconfig
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/part-of: trustee-operator
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  name: {{ .Release.Name }}-kbs-config
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  # List of secrets that should be loaded as KBS resources
  # containers-policy: Multiple policy variants (insecure/reject/signed)
  # cosign-keys: Public keys for signature verification
  # kbsres1: Sample secret for testing
  kbsSecretResources:
    - containers-policy
    - cosign-keys
    - kbsres1

  # Note: Other fields will be populated/updated by TrusteeConfig operator
  # Fields like kbsServiceType, kbsConfigMapName, etc. are controlled by TrusteeConfig
  # This CR only pre-configures the kbsSecretResources field, which is preserved
  # by the smart-merge logic
